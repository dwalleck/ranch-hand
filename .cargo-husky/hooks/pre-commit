#!/bin/sh
# Pre-commit hook for ranch-hand
# Runs beads flush, formatting, and linting before allowing commits
#
# To bypass hooks for work-in-progress commits:
#   git commit --no-verify -m "WIP: ..."
#
# To run with tests (slower):
#   RH_PRE_COMMIT_TEST=1 git commit -m "..."

set -e

# --- Beads flush (from beads pre-commit hook) ---
# This ensures that any pending bd issue changes are flushed to
# .beads/issues.jsonl before the commit is created

if command -v bd >/dev/null 2>&1; then
    if [ -d .beads ]; then
        echo "Flushing beads changes..."
        # Capture output for debugging but continue on failure
        if ! BD_OUTPUT=$(bd sync --flush-only 2>&1); then
            echo "Warning: bd sync --flush-only failed (continuing anyway)"
            echo "  Output: $BD_OUTPUT"
        fi
    fi
fi

# --- Cargo checks ---
echo "Running pre-commit checks..."

echo "Checking formatting..."
# Get list of files that need formatting before running fmt
UNFORMATTED=$(cargo fmt -- --check -l 2>/dev/null || true)
if [ -n "$UNFORMATTED" ]; then
    echo ""
    echo "Auto-formatting code..."
    cargo fmt
    # Only stage the files that were actually formatted (not all tracked changes)
    echo "$UNFORMATTED" | xargs git add
    echo ""
    echo "Code has been formatted and staged. Proceeding with commit."
fi

# Clippy treats warnings as errors in pre-commit for stricter enforcement
# (matches CI behavior, while regular cargo build keeps them as warnings)
echo "Running clippy..."
cargo clippy -- -D warnings

# Tests are run in CI - skip locally for faster commits
# Set RH_PRE_COMMIT_TEST=1 to run tests locally
if [ "${RH_PRE_COMMIT_TEST:-}" = "1" ]; then
    echo "Running tests..."
    cargo test --quiet
fi

echo "All pre-commit checks passed!"
